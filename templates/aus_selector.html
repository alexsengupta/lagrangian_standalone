<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Australia-wide Full-View Selector</title>
  <link rel="icon" href="data:,"> <!-- Prevents favicon.ico 404 -->
  <link href="https://unpkg.com/mapbox-gl@3.0.1/dist/mapbox-gl.css" rel="stylesheet"/>
  <style>
    body{margin:0;font-family:system-ui;background:#ECEFF1;padding-bottom:40px}
    .gridLabel{font-size:10px;color:#333;font-weight:bold;pointer-events:none}
    .marker{border-radius:50%;background:red;transform:translate(-50%,-50%);width:10px;height:10px;} 
    #main-content { display:flex; justify-content:center; align-items:flex-start; margin:20px auto; width:875px; }
    #map-container { background-color:#CFD8DC; padding:5px; border-radius:4px; }
    #map { width:800px; height:600px; border-radius:4px; }

    .controls-container { 
      width:800px; margin: 20px auto; background-color:#FFFFFF; 
      border:1px solid #B0BEC5; border-radius:5px; padding:15px;
      display: flex; flex-direction: column; gap: 15px;
    }
    .control-row { display: flex; justify-content: space-between; gap: 15px; }
    .control-col { flex: 1; display: flex; flex-direction: column; }
    .control-col label { margin-bottom: 5px; display: block; }
    .control-col input[type="range"], .control-col select { width: 100%; }
    .button-col { display: flex; align-items: center; }
    .controls-container button { 
      background:#607D8B; color:white; border:none; border-radius:4px;
      padding:10px 20px; font-size:1.3em; cursor: pointer; width:100%;
    }

    .info-popup {
      background-color: #E0E0E0; border:1px solid #B0BEC5; border-radius:5px;
      padding:10px; margin:20px auto; width:800px; text-align:center;
      font-size:0.9em; line-height:1.4;
    }
    .info-icon {
      display:inline-block; width:16px; height:16px; border-radius:50%;
      background-color:#607D8B; color:white; font-size:0.8em;
      font-weight:bold; text-align:center; line-height:16px; cursor:pointer;
      margin-left:5px; position:relative;
    }
    #info-popup-box {
      position:absolute; background-color:#FFFFCC; border:1px solid #B0BEC5;
      border-radius:5px; padding:10px; font-size:0.85em; line-height:1.3;
      width:250px; z-index:10000; box-shadow:2px 2px 5px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <h1 style="text-align:center">Select release location for particles</h1>
  <div class="info-popup">
    In this app you can release virtual drifters around Australia and simulate how they would move (either going forwards or backwards in time).
    The simulation uses ocean current data from the OSCAR model
    <a href="https://podaac.jpl.nasa.gov/dataset/OSCAR_L4_OC_NRT_V2.0" target="_blank">OSCAR link</a>.
  </div>
  <p style="text-align:center">
    Lat <span id="latOut">-20.00</span>
    Lon <span id="lonOut">152.00</span>
  </p>
  <div id="main-content">
    <div id="map-container">
      <div id="map"></div>
    </div>
  </div>

  <div class="controls-container">
    <div class="control-row">
      <div class="control-col">
        <label>Particles <span class="info-icon" data-info="Select the number of virtual drifters you release. The more you release the more calculations need to be done (so the simulation will take longer)">?</span><br/>
          <input id="np" type="range" min="1" max="50" step="1" value="10"><span id="npVal">10</span>
        </label>
      </div>
      <div class="control-col">
        <label>Release Area (°) <span class="info-icon" data-info="Select the area over which the virtual drifters will be randomly released">?</span><br/>
          <input id="area" type="range" min="0.1" max="2" step="0.1" value="0.5"><span id="areaVal">0.5</span>
        </label>
      </div>
      <div class="control-col button-col">
        <button id="runBtn">Run Simulation</button>
      </div>
    </div>
    <div class="control-row">
      <div class="control-col">
        <label>Duration (days) <span class="info-icon" data-info="Choose the length of the simulation. Longer durations will take longer to calculate">?</span><br/>
          <input id="dur" type="range" min="1" max="365" step="1" value="10"><span id="durVal">10</span>
        </label>
      </div>
      <div class="control-col">
        <label>Timestep (hours) <span class="info-icon" data-info="Shorter timesteps give more detailed trajectories but take longer">?</span><br/>
          <input id="dt" type="range" min="1" max="48" step="1" value="6"><span id="dtVal">6</span>
        </label>
      </div>
      <div class="control-col">
        <label>Direction <span class="info-icon" data-info="Run forwards or backwards in time">?</span></label><br/>
        <select id="dir">
          <option value="forwards">Forward</option>
          <option value="backwards">Backward</option>
        </select>
      </div>
    </div>
  </div>

  <div id="info-popup-box" style="display:none;"></div>

  <script src="https://unpkg.com/mapbox-gl@3.0.1/dist/mapbox-gl.js"></script>
  <script>
    const TOKEN = 'pk.eyJ1IjoiYWxleHNnIiwiYSI6ImNtZHNoa3l4NjBxbW4yam9oM2ZubDhvdGEifQ.RgU1tY3-ij_9UEWCaOFpEg';
    const SW = [100, -45];
    const NE = [160, -5];

    /* state */
    let marker = { lng: 152, lat: -20 };

    /* map */
    mapboxgl.accessToken = TOKEN;
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/light-v11',
      projection: 'mercator',
      center: [132.5, -25],
      zoom: 3,
      maxBounds: [SW, NE]
    });

    map.on('load', () => {
      map.fitBounds([SW, NE], { padding: 5 });

      // Bathymetry
      map.addSource('bathymetry', {
        type: 'vector',
        url: 'mapbox://mapbox.mapbox-bathymetry-v2'
      });
      map.addLayer({
        id: 'bathymetry-fill',
        type: 'fill',
        source: 'bathymetry',
        'source-layer': 'depth',
        paint: {
          'fill-color': 'rgba(0,100,255,0.1)',
          'fill-outline-color': 'rgba(0,0,255,0.2)'
        }
      });
      map.addLayer({
        id: 'bathymetry-contours',
        type: 'line',
        source: 'bathymetry',
        'source-layer': 'depth',
        paint: {
          'line-color': 'rgba(0,0,0,0.3)',
          'line-width': 0.5
        },
        layout: {
          'line-join': 'round',
          'line-cap': 'round'
        }
      });

      // Grid lines
      const lines = [];
      for (let lon = SW[0]; lon <= NE[0]; lon += 5) {
        lines.push({
          type: 'Feature',
          geometry: {
            type: 'LineString',
            coordinates: [[lon, SW[1]], [lon, NE[1]]]
          }
        });
      }
      for (let lat = SW[1]; lat <= NE[1]; lat += 5) {
        lines.push({
          type: 'Feature',
          geometry: {
            type: 'LineString',
            coordinates: [[SW[0], lat], [NE[0], lat]]
          }
        });
      }
      map.addSource('grid', {
        type: 'geojson',
        data: { type: 'FeatureCollection', features: lines }
      });
      map.addLayer({
        id: 'grid',
        type: 'line',
        source: 'grid',
        paint: { 'line-color': '#555', 'line-width': 0.5 }
      });

      // Labels
      for (let lon = SW[0]; lon <= NE[0]; lon += 5) {
        new mapboxgl.Marker({
          element: Object.assign(document.createElement('div'), {
            className: 'gridLabel',
            textContent: lon + '°E'
          })
        })
          .setLngLat([lon, SW[1] + 1.0])
          .addTo(map);
      }
      for (let lat = SW[1]; lat <= NE[1]; lat += 5) {
        new mapboxgl.Marker({
          element: Object.assign(document.createElement('div'), {
            className: 'gridLabel',
            textContent: Math.abs(lat) + '°S'
          })
        })
          .setLngLat([SW[0] + 5.0, lat])
          .addTo(map);
      }
    });

    /* red marker */
    const markerEl = document.createElement('div');
    markerEl.className = 'marker';
    const mbMarker = new mapboxgl.Marker(markerEl, { draggable: false })
      .setLngLat([marker.lng, marker.lat])
      .addTo(map);

    map.on('click', (e) => {
      marker.lng = e.lngLat.lng;
      marker.lat = e.lngLat.lat;
      mbMarker.setLngLat([marker.lng, marker.lat]);
      document.getElementById('latOut').textContent = marker.lat.toFixed(2);
      document.getElementById('lonOut').textContent = marker.lng.toFixed(2);
    });

    /* live sliders */
    ['np', 'area', 'dur', 'dt'].forEach((id) => {
      const el = document.getElementById(id);
      const out = document.getElementById(id + 'Val');
      el.addEventListener('input', () => {
        out.textContent = el.value;
        if (id === 'area') {
          markerEl.style.width = markerEl.style.height = 10 * el.value + 'px';
        }
      });
    });

    /* run button */
    document.getElementById('runBtn').addEventListener('click', () => {
      const dateStr = '2020-01-01';
      const param = `${marker.lng.toFixed(2)}_${marker.lat.toFixed(2)}_${document.getElementById('np').value}_${document.getElementById('area').value}_${document.getElementById('dir').value}_${document.getElementById('dur').value}_${document.getElementById('dt').value}_${dateStr}`;
      window.location.href = `/aus_lagrangian/${param}`;
    });

    // Info popup logic
    const infoPopupBox = document.getElementById('info-popup-box');
    let ignoreNextDocumentClick = false;
    document.querySelectorAll('.info-icon').forEach((icon) => {
        icon.addEventListener('click', (event) => {
        event.stopPropagation();
        const infoText = event.target.dataset.info;
        infoPopupBox.textContent = infoText;
        infoPopupBox.style.display = 'block';

        // Position the popup near the icon
        const rect = event.target.getBoundingClientRect();
        const scrollX = window.scrollX || window.pageXOffset;
        const scrollY = window.scrollY || window.pageYOffset;

        let topPos = rect.top + scrollY - infoPopupBox.offsetHeight - 10;
        let leftPos = rect.left + scrollX;

        // Clamp within viewport
        if (leftPos < 0) leftPos = 0;
        if (leftPos + infoPopupBox.offsetWidth > window.innerWidth) {
          leftPos = window.innerWidth - infoPopupBox.offsetWidth;
        }
        if (topPos < 0) {
          topPos = rect.bottom + scrollY + 10;
        }

        infoPopupBox.style.left = `${leftPos}px`;
        infoPopupBox.style.top = `${topPos}px`;
        infoPopupBox.style.visibility = 'visible';

        ignoreNextDocumentClick = true;
      });
    });
    document.addEventListener('click', (event) => {
      if (ignoreNextDocumentClick) {
        ignoreNextDocumentClick = false;
        return;
      }
      if (
        infoPopupBox.style.display === 'block' &&
        !infoPopupBox.contains(event.target) &&
        !event.target.classList.contains('info-icon')
      ) {
        infoPopupBox.style.display = 'none';
      }
    });
  </script>
</body>
</html>
